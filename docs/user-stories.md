# User Stories

## US-01: Регистрация пользователя

**Как** гость
**Я хочу** зарегистрировать учетную запись по имени пользователя, email и паролю
**Чтобы** я мог входить в систему и управлять своими задачами

### Acceptance criteria

* При отправке валидных `username`, `first_name`, `last_name`, `email`, `password` создается новый пользователь с уникальными `username` и `email`
* Поля `is_active = true`, `is_superuser = false` устанавливаются по умолчанию
* Пароль сохраняется только в виде хеша `password_hash`; исходный пароль не логируется и не хранится
* При попытке зарегистрировать уже существующий `username` или `email` возвращается `409 Conflict`, пользователь не создается
* При нарушении валидации (слишком короткий пароль, некорректный email и т.п.) возвращается `422 Unprocessable Entity`

---

## US-02: Авторизация (логин)

**Как** зарегистрированный пользователь
**Я хочу** войти по email и паролю
**Чтобы** получить токены доступа и работать с защищенными эндпоинтами

### Acceptance criteria

* При корректных `email` и `password` возвращается пара токенов: `access_token`, `refresh_token`, `token_type = "bearer"`
* Пользователь с `is_active = false` не может авторизоваться - возвращается `401 Unauthorized`
* При неверных учетных данных возвращается `401 Unauthorized` без уточнения, что именно неверно (email или пароль)
* Полученный `access_token` позволяет вызывать защищенные эндпоинты до истечения срока действия

---

## US-03: Обновление access-токена

**Как** авторизованный пользователь
**Я хочу** обновить access-токен по действующему refresh-токену
**Чтобы** не вводить логин и пароль повторно

### Acceptance criteria

* При отправке валидного `refresh_token` возвращается новый `access_token` и `token_type = "bearer"`
* При просроченном или недействительном `refresh_token` возвращается `401 Unauthorized`
* Новый `access_token` позволяет продолжать работу с защищенными эндпоинтами (задачи, категории, профиль)

---

## US-04: Просмотр своего профиля

**Как** авторизованный пользователь
**Я хочу** получить информацию о своем профиле
**Чтобы** понимать, под какой учетной записью я работаю

### Acceptance criteria

* При запросе с валидным access-токеном возвращаются поля: `id`, `username`, `email`, `first_name`, `last_name`, `is_active`, `is_superuser`, `created_at`, `updated_at`
* В ответе никогда не возвращаются пароль и `password_hash`
* При отсутствии или недействительности токена возвращается `401 Unauthorized`

---

## US-05: Обновление профиля

**Как** авторизованный пользователь
**Я хочу** изменить email и свои персональные данные профиля
**Чтобы** поддерживать учетную запись в актуальном состоянии

### Acceptance criteria

* Пользователь может изменить только поля: `email`, `first_name`, `last_name`
* Поле `email` должно быть валидным адресом электронной почты и уникальным среди всех пользователей
* Если какое-то поле не передано в запросе, оно не изменяется
* В ответе при успешном обновлении возвращаются актуальные данные пользователя: `id`, `username`, `email`, `first_name`, `last_name`, `is_active`, `is_superuser`, `created_at`, `updated_at`
* Через этот эндпоинт нельзя изменять `username` и пароль
* При попытке установить уже занятый `email` возвращается `409 Conflict`
* При невалидных данных (некорректный email, нарушение ограничений по длине и т.п.) возвращается `422 Unprocessable Entity`

---

## US-06: Создание задачи

**Как** авторизованный пользователь
**Я хочу** создавать задачи с заголовком, описанием, приоритетом, сроком и необязательной категорией
**Чтобы** управлять своим списком дел

### Acceptance criteria

* Обязательное поле - `title`
* Поле `user_id` берется из текущего пользователя и не передается в теле запроса
* Можно указать `category_id`; если категория не существует или принадлежит другому пользователю, возвращается `404 Not Found`
* В ответе возвращается созданная задача с полями: `id`, `title`, `description`, `priority`, `status`, `user_id`, `category_id`, `due_date`, `created_at`, `updated_at`, `completed_at`
* При невалидных данных возвращается `422 Unprocessable Entity`

---

## US-07: Просмотр списка задач с фильтрацией и сортировкой

**Как** авторизованный пользователь
**Я хочу** видеть список своих задач с возможностью фильтрации и сортировки
**Чтобы** быстро находить нужные задачи

### Acceptance criteria

* Список задач возвращается только для текущего пользователя
* Поддерживаются фильтры: `status_filter` (`pending`, `completed`, `all`, по умолчанию `all`), `category_id`, `search` (поиск по полю `title`)
* Поддерживаются параметры сортировки: `sort_by` (`priority`, `due_date`, `created_at`, `status`, по умолчанию `created_at`) и `order` (`asc`, `desc`, по умолчанию `desc`)
* Пагинация управляется параметрами `limit` (по умолчанию 20, максимум 100) и `offset` (по умолчанию 0); в ответе возвращаются поля `items`, `total`, `limit`, `offset`
* При невалидных значениях `status`, `sort_by` или `order` возвращается `422 Unprocessable Entity`
* При отсутствии или недействительности токена возвращается `401 Unauthorized`

---

## US-08: Обновление задачи

**Как** авторизованный пользователь
**Я хочу** обновлять параметры существующей задачи
**Чтобы** поддерживать ее данные в актуальном состоянии

### Acceptance criteria

* Можно изменять поля: `title`, `description`, `priority`, `category_id`, `due_date`
* Пользователь может изменять только собственные задачи
* При попытке обновить несуществующую задачу возвращается `404 Not Found`
* При невалидных данных возвращается `422 Unprocessable Entity`

---

## US-09: Удаление задачи

**Как** авторизованный пользователь
**Я хочу** удалять задачи, которые мне больше не нужны
**Чтобы** поддерживать список задач в порядке

### Acceptance criteria

* Пользователь может удалить только собственную задачу
* При успешном удалении возвращается `204 No Content`
* При удалении несуществующей задачи возвращается `404 Not Found`

---

## US-10: Управление категориями

**Как** авторизованный пользователь
**Я хочу** создавать, просматривать, изменять и удалять категории
**Чтобы** группировать задачи по смысловым блокам

### Acceptance criteria

* Пользователь может создавать категории с полями `name` (обязательно) и `description` (опционально); `user_id` берется из текущего пользователя
* Для одного пользователя значение `name` уникально (`UNIQUE (name, user_id)`)
* Пользователь видит только свои категории
* При попытке создать категорию с уже существующим `name` возвращается `409 Conflict`
* При удалении категории у всех задач пользователя `category_id` устанавливается в `null`

---

## US-11: Просмотр категорий задач пользователя

**Как** авторизованный пользователь
**Я хочу** просматривать список своих категорий
**Чтобы** фокусироваться на задачах конкретной сферы

### Acceptance criteria

* Возвращается список категорий, принадлежащих текущему пользователю
* Для каждой категории в ответе присутствует `tasks_count` (количество задач в категории)
* При отсутствии или недействительности токена возвращается `401 Unauthorized`

---

## US-12: Отметка задачи как выполненной и повторное открытие

**Как** авторизованный пользователь
**Я хочу** отмечать задачу выполненной и при необходимости возвращать ее в работу
**Чтобы** управлять статусом задач и видеть актуальный прогресс

### Acceptance criteria

* Для отметки задачи выполненной используется эндпоинт `PATCH /tasks/{task_id}/complete`

  * Устанавливается `status = "completed"`
  * Поле `completed_at` заполняется текущим UTC-временем
  * Поле `updated_at` обновляется

* Для возврата задачи в работу используется эндпоинт `PATCH /tasks/{task_id}/uncomplete`

  * Устанавливается `status = "pending"`
  * Поле `completed_at` сбрасывается в `null`
  * Поле `updated_at` обновляется

* Если задача не найдена или не принадлежит пользователю, возвращается `404 Not Found`

* При отсутствии или недействительности токена возвращается `401 Unauthorized`
