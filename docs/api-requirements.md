# Требования к API

## 1. Общая информация

* Базовый префикс всех версионированных маршрутов: `/api`
* Формат запросов и ответов: `application/json; charset=utf-8`
* Все даты и время передаются в формате ISO 8601 с указанием часового пояса
  например, `2025-11-23T10:00:00Z`
* Аутентификация: Bearer access-token в заголовке
  `Authorization: Bearer <access_token>`
* Все защищённые эндпоинты доступны только при наличии валидного access-токена
* Системный эндпоинт проверки здоровья сервиса доступен по пути `/api/health`

### 1.1. Общие коды ответов

* `200 OK` - успешный запрос
* `201 Created` - ресурс успешно создан
* `204 No Content` - успешный запрос без тела ответа
* `400 Bad Request` - неверные параметры запроса либо некорректный JSON
* `401 Unauthorized` - отсутствует или недействителен токен
* `403 Forbidden` - у текущего пользователя нет прав на данный ресурс
* `404 Not Found` - указанный ресурс не найден
* `409 Conflict` - конфликт данных (нарушение уникальности и т.п.)
* `422 Unprocessable Entity` - ошибка валидации входных данных
* `500 Internal Server Error` - внутренняя ошибка сервера

---

## 2. Authentication (аутентификация)

### 2.1. POST /api/v1/auth/register - регистрация пользователя

Регистрация нового пользователя и создание учетной записи.

**Аутентификация:** не требуется

**Тело запроса**

```json
{
  "username": "john_doe",
  "email": "john@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "password": "MySecurePass123!"
}
```

* `username` - строка, 3–50 символов
* `email` - строка, валидный email
* `password` - строка, минимум 8 символов

**Ответ 201 Created**

```json
{
  "id": 1,
  "username": "john_doe",
  "email": "john@example.com",
  "first_name": "John",
  "last_name": "Doe"
  "is_active": true,
  "is_superuser": false,
  "created_at": "2025-11-23T10:00:00Z",
  "updated_at": "2025-11-23T10:00:00Z"
}
```

**Возможные ошибки**

* `409 Conflict` - `username` или `email` уже заняты
* `422 Unprocessable Entity` - не пройдена валидация полей

---

### 2.2. POST /api/v1/auth/login - аутентификация пользователя

Аутентификация по email и паролю и выдача пары токенов.

**Аутентификация:** не требуется

**Тело запроса**

```json
{
  "email": "john@example.com",
  "password": "MySecurePass123!"
}
```

**Ответ 200 OK**

```json
{
  "access_token": "ACCESS_TOKEN_JWT",
  "refresh_token": "REFRESH_TOKEN_JWT",
  "token_type": "bearer"
}
```

**Возможные ошибки**

* `401 Unauthorized` - неверные учётные данные или пользователь деактивирован
* `422 Unprocessable Entity` - некорректное тело запроса

---

### 2.3. POST /api/v1/auth/refresh - обновление access токена

Получение нового access-токена по действующему refresh-токену.

**Аутентификация:** не требуется

**Тело запроса**

```json
{
  "refresh_token": "REFRESH_TOKEN_JWT"
}
```

**Ответ 200 OK**

```json
{
  "access_token": "NEW_ACCESS_TOKEN_JWT",
  "token_type": "bearer"
}
```

**Возможные ошибки**

* `401 Unauthorized` - недействительный или просроченный `refresh_token`
* `422 Unprocessable Entity` - отсутствует обязательное поле или некорректный JSON

---

## 3. Users (пользователи)

### 3.1. GET /api/v1/users/me - получение профиля текущего пользователя

Возвращает информацию о текущем авторизованном пользователе.

**Аутентификация:** требуется

**Тело запроса:** отсутствует

**Ответ 200 OK**

```json
{
  "id": 1,
  "username": "john_doe",
  "email": "john@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "is_active": true,
  "is_superuser": false,
  "created_at": "2025-11-23T10:00:00Z",
  "updated_at": "2025-11-23T10:00:00Z"
}
```

**Возможные ошибки**

* `401 Unauthorized` - токен не передан или недействителен

---

### 3.2. PUT /api/v1/users/me - обновление профиля текущего пользователя

Обновляет профиль текущего пользователя.
Через этот эндпоинт можно изменить **только** `email`, `first_name` и `last_name`

**Аутентификация:** требуется

**Тело запроса**

```json
{
  "email": "new@example.com",
  "first_name": "John",
  "last_name": "Doe"
}
```

Все поля опциональны:

* `email` - необязательная строка, валидный email, должен быть уникален среди пользователей
* `first_name` - необязательная строка, имя пользователя
* `last_name` - необязательная строка, фамилия пользователя

**Ответ 200 OK**

```json
{
  "id": 1,
  "username": "john_doe",
  "email": "new@example.com",
  "first_name": "John",
  "last_name": "Doe",
  "is_active": true,
  "is_superuser": false,
  "created_at": "2025-11-23T10:00:00Z",
  "updated_at": "2025-11-24T09:00:00Z"
}
```

Возвращаются обновленные данные текущего пользователя.

**Возможные ошибки**

* `401 Unauthorized` – отсутствует или недействителен токен
* `409 Conflict` – указанный `email` уже занят другим пользователем
* `422 Unprocessable Entity` – невалидные данные (некорректный email, нарушение ограничений длины и т.п.)

---

### 3.3. POST /api/v1/users/me/change-password - изменение пароля

Изменяет пароль текущего пользователя при знании текущего пароля.

**Аутентификация:** требуется

**Тело запроса**

```json
{
  "current_password": "MySecurePass123!",
  "new_password": "NewStrongPass123!"
}
```

* `current_password` - обязательная строка, текущий пароль
* `new_password` - обязательная строка, минимум 8 символов

**Ответ 200 OK**

```json
{
  "detail": "Password changed successfully"
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен, либо указан неверный текущий пароль
* `422 Unprocessable Entity` - новый пароль не удовлетворяет требованиям

---

## 4. Tasks (задачи)

Модель задачи содержит поля:
`id`, `title`, `description`, `user_id`, `category_id`, `priority`, `status`, `due_date`, `created_at`, `updated_at`, `completed_at`

Enum-значения:

* `priority` – `"low"`, `"medium"`, `"high"`
* `status` – `"pending"`, `"completed"`

---

### 4.1. GET /api/v1/tasks - список задач пользователя

Возвращает список задач текущего пользователя с фильтрацией, сортировкой и пагинацией.

**Аутентификация:** требуется

**Query-параметры**

* `limit` - целое, количество задач в ответе, по умолчанию 20, максимум 100
* `offset` - целое, смещение от начала списка, по умолчанию 0
* `status` - фильтр по статусу

  * возможные значения: `"pending"`, `"completed"`, `"all"`
  * по умолчанию `"all"`
* `category_id` - фильтр по категории

  * `category_id={id}` - задачи только этой категории текущего пользователя
  * `category_id=null` - задачи без категории
* `search` - строка для поиска по названию (`title`), регистронезависимый поиск
* `sort_by` - поле сортировки

  * возможные значения: `priority`, `due_date`, `created_at`, `status`
  * по умолчанию `created_at`
* `order` - направление сортировки

  * возможные значения: `asc`, `desc`
  * по умолчанию `desc`

По умолчанию задачи отсортированы по `created_at desc` (сначала новые)

**Ответ 200 OK**

```json
{
  "items": [
    {
      "id": 10,
      "title": "Купить молоко",
      "description": "2L, low fat",
      "priority": "medium",
      "status": "pending",
      "user_id": 1,
      "category_id": 3,
      "due_date": "2025-11-25T18:00:00Z",
      "created_at": "2025-11-23T10:00:00Z",
      "updated_at": "2025-11-23T10:00:00Z",
      "completed_at": null
    }
  ],
  "total": 25,
  "limit": 20,
  "offset": 0
}
```

* `items` - задачи пользователя после применения фильтров и сортировки
* `total` - общее количество задач после применения фильтров, без учёта `limit` и `offset`
* `limit` - использованный лимит
* `offset` - использованное смещение

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `422 Unprocessable Entity` - невалидные значения `status`, `sort_by` или `order`

---

### 4.2. POST /api/v1/tasks - создание новой задачи

Создает новую задачу для текущего пользователя.
По умолчанию устанавливаются `status = "pending"` и `priority = "medium"`.

**Аутентификация:** требуется

**Тело запроса**

```json
{
  "title": "Finish homework",
  "description": "Implement API docs",
  "category_id": 2,
  "priority": "high",
  "due_date": "2025-11-24T20:00:00Z"
}
```

* `title` - обязательная строка, максимум 200 символов
* `description` - опциональная строка (text)
* `category_id` - опционально, целое, идентификатор категории пользователя
* `priority` - опционально, `"low"`, `"medium"` или `"high"`, по умолчанию `"medium"`
* `due_date` - опционально, дата/время в формате ISO 8601

`user_id` берется из текущего пользователя и в теле запроса не передается

**Ответ 201 Created**

```json
{
  "id": 11,
  "title": "Finish homework",
  "description": "Implement API docs",
  "priority": "high",
  "status": "pending",
  "user_id": 1,
  "category_id": 2,
  "due_date": "2025-11-24T20:00:00Z",
  "created_at": "2025-11-23T19:00:00Z",
  "updated_at": "2025-11-23T19:00:00Z",
  "completed_at": null
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - указанная категория не существует или не принадлежит пользователю
* `422 Unprocessable Entity` - невалидные данные

---

### 4.3. GET /api/v1/tasks/{id} - получение задачи по ID

Возвращает одну задачу по идентификатору.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор задачи

**Ответ 200 OK**

```json
{
  "id": 11,
  "title": "Finish homework",
  "description": "Implement API docs",
  "priority": "high",
  "status": "pending",
  "user_id": 1,
  "category_id": 2,
  "due_date": "2025-11-24T20:00:00Z",
  "created_at": "2025-11-23T19:00:00Z",
  "updated_at": "2025-11-23T19:00:00Z",
  "completed_at": null
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - задача не найдена или не принадлежит пользователю

---

### 4.4. PUT /api/v1/tasks/{id} - обновление задачи

Обновляет существующую задачу, изменяя только переданные поля.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор задачи

**Тело запроса**

```json
{
  "title": "Finish homework today",
  "description": "Do it before 22:00",
  "category_id": 3,
  "priority": "medium",
  "due_date": "2025-11-24T22:00:00Z",
  "status": "completed"
}
```

Обновляемые поля (все опциональны):

* `title` - строка, максимум 200 символов
* `description` - строка (text)
* `category_id` - целое или `null`
* `priority` - `"low"`, `"medium"`, `"high"`
* `due_date` - дата/время в ISO 8601 или `null`

**Ответ 200 OK**

```json
{
  "id": 11,
  "title": "Finish homework today",
  "description": "Do it before 22:00",
  "priority": "medium",
  "status": "completed",
  "user_id": 1,
  "category_id": 3,
  "due_date": "2025-11-24T22:00:00Z",
  "created_at": "2025-11-23T19:00:00Z",
  "updated_at": "2025-11-24T10:00:00Z",
  "completed_at": "2025-11-24T09:30:00Z"
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - задача не найдена или не принадлежит пользователю
* `422 Unprocessable Entity` - невалидные данные

---

### 4.5. DELETE /api/v1/tasks/{id} - удаление задачи

Удаляет задачу текущего пользователя.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор задачи

**Ответ 204 No Content**

Тело отсутствует.

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - задача не найдена или не принадлежит пользователю

---

### 4.6. PATCH /api/v1/tasks/{id}/complete - отметить задачу выполненной

Помечает задачу как выполненную.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор задачи

**Ответ 200 OK**

```json
{
  "id": 11,
  "title": "Finish homework",
  "description": "Implement API docs",
  "priority": "high",
  "status": "completed",
  "user_id": 1,
  "category_id": 2,
  "due_date": "2025-11-24T20:00:00Z",
  "created_at": "2025-11-23T19:00:00Z",
  "updated_at": "2025-11-24T10:00:00Z",
  "completed_at": "2025-11-24T10:00:00Z"
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - задача не найдена или не принадлежит пользователю

---

### 4.7. PATCH /api/v1/tasks/{id}/uncomplete - отметить задачу невыполненной

Сбрасывает выполнение задачи, выставляя `status = "pending"` и `completed_at = null`.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор задачи

**Ответ 200 OK**

```json
{
  "id": 11,
  "title": "Finish homework",
  "description": "Implement API docs",
  "priority": "high",
  "status": "pending",
  "user_id": 1,
  "category_id": 2,
  "due_date": "2025-11-24T20:00:00Z",
  "created_at": "2025-11-23T19:00:00Z",
  "updated_at": "2025-11-24T10:05:00Z",
  "completed_at": null
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - задача не найдена или не принадлежит пользователю

---

### 4.8. GET /api/v1/tasks/statis - статистика по задачам

Возвращает статистику по задачам текущего пользователя.

**Аутентификация:** требуется

**Тело запроса:** отсутствует

**Ответ 200 OK**

```json
{
  "total": 25,
  "completed": 15,
  "pending": 10,
  "completion_rate": 60.25
}
```

* `total` - общее количество задач пользователя
* `completed` - количество задач со статусом `completed`
* `pending` - количество задач со статусом `pending`
* `completion_rate` - процент выполненных задач от общего числа:
  `(completed / total) * 100`, значение в диапазоне 0–100 (округляется до 2 знаков)


**Возможные ошибки**

* `401 Unauthorized` - пользователь не аутентифицирован

---

## 5. Categories (категории)

Категории задач, принадлежащие текущему пользователю.

---

### 5.1. GET /api/v1/categories - список категорий пользователя

Возвращает список всех категорий текущего пользователя.

**Аутентификация:** требуется

**Ответ 200 OK**

```json
[
  {
    "id": 1,
    "name": "Work",
    "description": "Рабочие задачи",
    "tasks_count": 3,
    "created_at": "2025-11-20T10:00:00Z"
  },
  {
    "id": 2,
    "name": "Personal",
    "description": "Личные задачи",
    "tasks_count": 2,
    "created_at": "2025-11-21T09:00:00Z"
  }
]
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен

```json
{
  "detail": "Not authenticated"
}
```

---

### 5.2. POST /api/v1/categories - создание категории

Создает новую категорию для текущего пользователя.

**Аутентификация:** требуется

**Тело запроса**

```json
{
  "name": "Personal",
  "description": "Личные задачи"
}
```

* `name` - обязательная строка, максимум 100 символов, уникальна в рамках пользователя
* `description` - опциональная строка (text)

**Ответ 201 Created**

```json
{
  "id": 2,
  "name": "Personal",
  "description": "Личные задачи",
  "created_at": "2025-11-21T09:00:00Z",
  "updated_at": "2025-11-21T09:00:00Z"
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `409 Conflict` - категория с таким `name` уже существует у пользователя
* `422 Unprocessable Entity` - невалидные данные

---

### 5.3. PUT /api/v1/categories/{id} - обновление категории

Обновляет существующую категорию текущего пользователя.

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор категории

**Тело запроса**

```json
{
  "name": "Health",
  "description": "Задачи по здоровью и спорту"
}
```

* `name` - опционально, новое имя категории, максимум 100 символов, уникально для пользователя
* `description` - опционально, новое описание

**Ответ 200 OK**

```json
{
  "id": 3,
  "name": "Health",
  "description": "Задачи по здоровью и спорту",
  "created_at": "2025-11-20T10:00:00Z",
  "updated_at": "2025-11-24T09:00:00Z"
}
```

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - категория не найдена или не принадлежит пользователю
* `409 Conflict` - другая категория пользователя уже использует указанное имя
* `422 Unprocessable Entity` - невалидные данные

---

### 5.4. DELETE /api/v1/categories/{id} - удаление категории

Удаляет категорию текущего пользователя. Все задачи этой категории становятся без категории (`category_id = null`)

**Аутентификация:** требуется

**Параметры пути**

* `id` - целое, идентификатор категории

**Ответ 204 No Content**

Тело отсутствует.

**Возможные ошибки**

* `401 Unauthorized` - отсутствует или недействителен токен
* `404 Not Found` - категория не найдена или не принадлежит пользователю

---

## 6. System

### 6.1. GET /api/health - проверка состояния сервиса

Проверка работоспособности сервиса и подключений к основным зависимостям.

**Аутентификация:** не требуется

**Ответ 200 OK**

```json
{
  "status": "healthy",
  "database": "connected",
  "timestamp": "2025-12-12T15:04:32.662666Z"
}
```

**Возможные ошибки**

* `500 Internal Server Error` - сервис не готов обрабатывать запросы