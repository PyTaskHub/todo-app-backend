# Схема базы данных

База данных реализует сервис управления задачами (to-do) с пользователями, их категориями и задачами.

ER-диаграмма (`docs/er-diagram.png`) показывает:
- три основные таблицы: `users`, `categories`, `tasks`
- все поля и их типы данных
- первичные ключи (PK)
- внешние ключи (FK)
- признак `NOT NULL`

Данный документ дополняет диаграмму и явно описывает:
- назначение таблиц
- ограничения `UNIQUE`
- индексы
- значения по умолчанию
- связи между таблицами

Также используются перечисления:

- `task_priority` - приоритет задачи: `low`, `medium`, `high`
- `task_status` - статус задачи: `pending`, `completed`

---

## Таблица `users`

### Назначение

Хранит учётные записи пользователей системы и базовую информацию, необходимую для аутентификации и авторизации.

### Структура таблицы

- `id` - `int`, **PK**, `NOT NULL`  
  Уникальный идентификатор пользователя. Наследуется от базовой модели.

- `username` - `varchar(50)`, `NOT NULL`  
  Имя пользователя / логин, используемый для входа.

- `email` - `varchar(255)`, `NOT NULL`  
  Адрес электронной почты пользователя.

- `password_hash` - `varchar(255)`, `NOT NULL`  
  Хэш пароля (bcrypt).

- `is_active` - `boolean`, `NOT NULL`, значение по умолчанию: `true`  
  Признак того, что учётная запись активна и пользователь может входить в систему.

- `is_superuser` - `boolean`, `NOT NULL`, значение по умолчанию: `false`  
  Признак суперпользователя / администратора.

- `created_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время создания записи.

- `updated_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время последнего обновления записи. Обновляется автоматически при изменении.

### Ограничения и индексы

- `PRIMARY KEY (id)`

- Уникальные ограничения:
  - `UNIQUE (username)` гарантирует, что логин пользователя уникален.
  - `UNIQUE (email)` гарантирует уникальность e-mail.

- Индексы:
  - по полю `username` для быстрого поиска пользователя по логину.
  - по полю `email` для быстрого поиска пользователя по адресу электронной почты.


### Связи

- Один пользователь может иметь множество:
  - категорий (`categories`)
  - задач (`tasks`)

Связи реализуются внешними ключами в таблицах `categories.user_id` и `tasks.user_id`

---

## Таблица `categories`

### Назначение

Хранит категории задач. Категории всегда принадлежат конкретному пользователю и позволяют группировать его задачи по смыслу.

### Структура таблицы

- `id` - `int`, **PK**, `NOT NULL`  
  Уникальный идентификатор категории.

- `name` - `varchar(100)`, `NOT NULL`  
  Название категории.

- `description` - `text`, допускает `NULL`  
  Описание категории (опционально)

- `user_id` - `int`, `NOT NULL`  
  Внешний ключ на владельца категории: `user_id` → `users.id`

- `created_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время создания записи.

- `updated_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время последнего обновления записи.

### Ограничения и индексы

- `PRIMARY KEY (id)`
- Внешний ключ:
  - `user_id` → `users.id` с `ON DELETE CASCADE`
  - При удалении пользователя все его категории удаляются автоматически.
- Уникальное ограничение:
  - `UNIQUE (name, user_id)` один пользователь не может создать две категории с одинаковым названием.
- Индексы:
  - по полю `user_id` для быстрого поиска категорий конкретного пользователя.

### Связи

- Один пользователь (`users`) может иметь множество категорий (`categories`)
- Каждая категория принадлежит ровно одному пользователю
- Одна категория может быть назначена множеству задач (`tasks`) через поле `tasks.category_id`

---

## Таблица `tasks`

### Назначение

Хранит задачи пользователя. Задача всегда принадлежит какому-то пользователю и может быть опционально привязана к категории.

### Перечисления

- `task_priority`:
  - `low` - низкий приоритет
  - `medium` - средний приоритет (значение по умолчанию)
  - `high` - высокий приоритет

- `task_status`:
  - `pending` - задача создана / в процессе выполнения
  - `completed` - задача выполнена

### Структура таблицы

- `id` - `int`, **PK**, `NOT NULL`  
  Уникальный идентификатор задачи.

- `title` - `varchar(200)`, `NOT NULL`  
  Краткий заголовок задачи, обязательное поле.

- `description` - `text`, допускает `NULL`  
  Подробное описание задачи (опционально)

- `user_id` - `int`, `NOT NULL`  
  Внешний ключ на владельца задачи: `user_id` → `users.id`

- `category_id` - `int`, допускает `NULL`  
  Внешний ключ на категорию: `category_id` → `categories.id`  
  Может быть `NULL`, если задача не отнесена к какой-либо категории.

- `priority` - `task_priority`, `NOT NULL`, значение по умолчанию: `medium`  
  Приоритет задачи (низкий, средний или высокий).

- `status` - `task_status`, `NOT NULL`, значение по умолчанию: `pending`  
  Текущий статус задачи (ожидает выполнения / выполнена)

- `due_date` - `timestamptz`, допускает `NULL`  
  Дедлайн задачи, с учётом часового пояса (опционально)

- `created_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время создания записи.

- `updated_at` - `timestamptz`, `NOT NULL`, значение по умолчанию: `now()`  
  Время последнего обновления записи.

- `completed_at` - `timestamptz`, допускает `NULL`  
  Время, когда задача была завершена. Заполняется при переводе задачи в состояние `completed`

### Ограничения и индексы

- `PRIMARY KEY (id)`
- Внешние ключи:
  - `user_id` → `users.id` с `ON DELETE CASCADE`
  - При удалении пользователя все его задачи удаляются автоматически.
  - `category_id` → `categories.id` с `ON DELETE SET NULL`
  - При удалении категории поле `category_id` в задачах устанавливается в `NULL`
- Значения по умолчанию:
  - `priority` = `medium`
  - `status` = `pending`
  - `created_at` и `updated_at` = `now()`
- Индексы:
  - по `user_id` (поиск задач конкретного пользователя)
  - по `status` (фильтрация задач по статусу)
  - по `priority` (фильтрация задач по приоритету)

### Связи

- Один пользователь может иметь множество задач.
- Каждая задача принадлежит одному пользователю (`tasks.user_id` → `users.id`)
- Категория может содержать множество задач (`tasks.category_id` → `categories.id`)
- Привязка к категории для задачи является опциональной (`category_id` допускает `NULL`)

---

## Итоговые связи между таблицами

- `users (1) - (N) categories`  
  Связь реализована полем `categories.user_id`

- `users (1) - (N) tasks`  
  Связь реализована полем `tasks.user_id`

- `categories (1) - (N) tasks`  
  Связь реализована полем `tasks.category_id`
  Для задачи эта связь опциональна: задача может существовать без категории.

Данная текстовая схема вместе с ER-диаграммой в `docs/er-diagram.png` полностью описывает структуру базы данных проекта.
